<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VFind - Profil</title>
  <link rel="stylesheet" href="style/main.css"/>
  <style>
    .popup-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .popup {
      background: #fff;
      color: black;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      max-width: 90vw;
    }
    .popup input {
      padding: 0.5rem;
      margin-top: 1rem;
      width: 80%;
    }
    .popup button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body class="vfind-bg">

<header class="header-solo">
  <div class="header-row">
    <a href="index.html" class="back-btn" title="Retour">
      <img src="assets/icons/arrow_back.svg" alt="Retour" />
    </a>
    <h1>Mon Profil</h1>
    <div class="top-buttons">
      <a href="parametres.html" class="btn-icon">
        <img src="assets/icons/settings.svg" alt="ParamÃ¨tres" />
      </a>
    </div>
  </div>
  <div class="id-user" id="idUserDisplay">(ID...)</div>
</header>

<section class="profil-top">
  <div class="profil-solde-bar">
    <div class="solde-piece">
      <img src="assets/img/vcoin.webp" alt="VCoins" class="vcoin-solo" />
      <span id="vcoins">100</span>
    </div>
    <div class="solde-jeton">
      <img src="assets/img/jeton_p.webp" alt="Jetons" class="jeton-solo" />
      <span id="jetons">6</span>
    </div>
  </div>
</section>

<!-- === BLOCPARRAINAGE CODE/LINK Ã€ RAJOUTER ICI -->
<div id="parrainage-bloc" style="margin:2rem auto;max-width:400px;text-align:center;">
  <input type="text" id="codeParrain" placeholder="Code parrain (optionnel)" style="padding:8px;width:70%;max-width:220px;border-radius:8px;border:none;margin-bottom:8px;">
  <button id="btn-activate-parrain" style="padding:8px 18px;border-radius:8px;border:none;background:#41d675;color:#fff;font-weight:bold;cursor:pointer;">Valider code</button>
  <p id="parrain-feedback" style="color:#fa4a4a;margin-top:7px;"></p>
</div>

<main class="profil-container">
  <section class="profil-sections">
    <button onclick="location.href='cadres.html'">ğŸ¨ Mes cadres</button>
    <button onclick="location.href='amis.html'">ğŸ‘¥ Mes amis</button>
    <button onclick="location.href='calendrier.html'">ğŸ“… Mon calendrier</button>
    <button onclick="location.href='historique.html'">ğŸ“œ Historique</button>
    <button onclick="location.href='photos_aimees.html'">â¤ï¸ Photos aimÃ©es</button>
    <button onclick="location.href='photos_signalees.html'">ğŸš© Photos signalÃ©es</button>
  </section>
</main>

<footer>
  <p>Â© 2025 VFind</p>
</footer>

<!-- âœ… POPUP -->
<div class="popup-bg" id="popupID">
  <div class="popup">
    <p>Souhaitez-vous modifier votre identifiant public ?</p>
    <input type="text" id="newIdInput" placeholder="Nouvel ID unique" />
    <br />
    <button id="validateId">Valider</button>
    <button onclick="document.getElementById('popupID').style.display='none'">Annuler</button>
    <p id="idError" style="color:red;margin-top:1rem;"></p>
  </div>
</div>

<!-- âœ… FIREBASE + PARRAINAGE CODE/LINK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD2AttV3LYAsWShgIMEPIvfpc6wmPpsK3U",
    authDomain: "vfind-12866.firebaseapp.com",
    projectId: "vfind-12866",
    storageBucket: "vfind-12866.appspot.com",
    messagingSenderId: "953801570333",
    appId: "1:953801570333:web:92ed5e604d0df316046ef4",
    measurementId: "G-WTSN5KCBDJ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, async (user) => {
    if (!user) return await signInAnonymously(auth);

    const uid = user.uid;
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      await setDoc(ref, {
        points: 100,
        jetons: 3,
        pseudoPublic: "",
        idFixe: false
      });
    }

    const profil = (await getDoc(ref)).data();
    document.getElementById("vcoins").textContent = profil.points || 0;
    document.getElementById("jetons").textContent = profil.jetons || 0;

    const idDisplay = document.getElementById("idUserDisplay");
    idDisplay.textContent = profil.pseudoPublic ? "ID : " + profil.pseudoPublic : "ğŸ”´ Cliquez pour crÃ©er votre ID";
    if (!profil.idFixe) {
      idDisplay.style.textDecoration = "underline";
      idDisplay.onclick = () => {
        document.getElementById("popupID").style.display = "flex";
        document.getElementById("newIdInput").value = "";
        document.getElementById("idError").textContent = "";
      };

      document.getElementById("validateId").onclick = async () => {
        const newId = document.getElementById("newIdInput").value.trim();
        const err = document.getElementById("idError");

        if (newId.length < 3) {
          err.textContent = "ID trop court (min 3 caractÃ¨res)";
          return;
        }

        // VÃ©rifie si dÃ©jÃ  pris
        const q = query(collection(db, "users"), where("pseudoPublic", "==", newId));
        const res = await getDocs(q);

        if (!res.empty) {
          err.textContent = "ID dÃ©jÃ  pris ğŸ˜•";
        } else {
          await updateDoc(ref, {
            pseudoPublic: newId,
            idFixe: true
          });
          idDisplay.textContent = "ID : " + newId;
          document.getElementById("popupID").style.display = "none";
          idDisplay.style.textDecoration = "none";
          idDisplay.onclick = null;
        }
      };
    }

    // === AUTO-REMPLISSAGE CODE PARRAIN SI VIA LIEN
    const params = new URLSearchParams(window.location.search);
    if (params.has('parrain')) {
      document.getElementById('codeParrain').value = params.get('parrain');
    }

    // === VALIDATION CODE/LINK PARRAINAGE ===
    document.getElementById("btn-activate-parrain").onclick = async function() {
      const codeParrain = document.getElementById('codeParrain').value.trim();
      const feedback = document.getElementById('parrain-feedback');
      if (!codeParrain) {
        feedback.textContent = "Entre un code parrain !";
        feedback.style.color = "#fa4a4a";
        return;
      }
      if (codeParrain === user.uid) {
        feedback.textContent = "Tu ne peux pas te parrainer toi-mÃªme ğŸ˜…";
        feedback.style.color = "#fa4a4a";
        return;
      }
      try {
        const parrainRef = doc(db, "users", codeParrain);
        const parrainSnap = await getDoc(parrainRef);
        if (!parrainSnap.exists()) {
          feedback.textContent = "Ce code parrain n'existe pas.";
          feedback.style.color = "#fa4a4a";
          return;
        }
        // EmpÃªcher de re-parrainer plusieurs fois avec le mÃªme compte
        const snap = await getDoc(ref);
        if (snap.exists() && snap.data().parrain) {
          feedback.textContent = "Tu as dÃ©jÃ  utilisÃ© un code parrain.";
          feedback.style.color = "#fa4a4a";
          return;
        }
        // Donne la rÃ©compense au parrain
        const parrainData = parrainSnap.data();
        let nbFilleuls = parrainData.filleuls || 0;
        nbFilleuls++;
        let newPoints = (parrainData.points || 0) + 300;
        let cadres = parrainData.cadres || [];
        if (nbFilleuls === 3 && !cadres.includes('polaroid_302')) {
          cadres.push('polaroid_302');
        }
        await updateDoc(parrainRef, {
          points: newPoints,
          filleuls: nbFilleuls,
          cadres: cadres
        });
        // Note dans ton propre profil que tu as Ã©tÃ© parrainÃ© (pour bloquer les abus)
        await updateDoc(ref, { parrain: codeParrain });
        feedback.style.color = "#41d675";
        feedback.textContent = "Code acceptÃ© ! Merci ğŸ‰";
        setTimeout(() => { feedback.textContent = ""; }, 4000);
      } catch (e) {
        feedback.textContent = "Erreur technique, rÃ©essaie plus tard.";
        feedback.style.color = "#fa4a4a";
      }
    };
  });
</script>
</body>
</html>
